<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Encomendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; }
    header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 10px 30px;
      background: #fff;
      width: 100%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header img {
      height: 50px;
      margin-right: 15px;
    }
    header h1 {
      font-size: 1.6em;
      margin: 0;
    }
    h2, h3 { text-align: center; }
    form, .encomendas {
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      max-width: 700px;
      box-shadow: 0 0 10px #ccc;
    }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, button { width: 100%; padding: 8px; margin-top: 5px; }
    .cliente-container { display: flex; gap: 10px; align-items: center; }
    .cliente-container input[type="text"] { flex: 1; }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
    }
    #calendario {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo CB Systems">
    <h1>Painel de Encomendas</h1>
  </header>

  <form id="form-encomenda">
    <label>Pesquisar Cliente</label>
    <div class="cliente-container">
      <input list="clientes" id="clienteSelect" name="cliente" required />
      <datalist id="clientes"></datalist>
      <button type="button" onclick="abrirModal()">+</button>
    </div>

    <label>Produto</label>
    <input type="text" name="produto" required>

    <label>Data de Entrega</label>
    <input type="date" name="dataEntrega" required>

    <label>Valor</label>
    <input type="number" step="0.01" name="valor" required>

    <label>Valor de Adiantamento</label>
    <input type="number" step="0.01" name="adiantamento" required>

    <button type="submit">Registrar Encomenda</button>
  </form>

  <div class="encomendas">
    <h3>üóìÔ∏è Calend√°rio de Entregas</h3>
    <div id="calendario"></div>
  </div>

  <!-- MODAL DE CADASTRO DE CLIENTE -->
  <div class="modal" id="modalCliente">
    <div class="modal-content">
      <h3>Cadastrar Cliente</h3>
      <form id="form-cliente">
        <label>Nome</label>
        <input type="text" name="nome" required>
        <label>Telefone</label>
        <input type="text" name="telefone" required>
        <label>Endere√ßo</label>
        <input type="text" name="endereco">
        <button type="submit">Cadastrar</button>
        <button type="button" onclick="fecharModal()">Fechar</button>
      </form>
    </div>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzTUJhfTqIh_iuuueWGUDzfnF6Cj6B7s6S8TIIe7UypibqqyfUkN2--c1FkCg6Hgs41/exec';

    function abrirModal() {
      document.getElementById('modalCliente').style.display = 'flex';
    }

    function fecharModal() {
      document.getElementById('modalCliente').style.display = 'none';
    }

    document.getElementById('form-encomenda').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.append("tipo", "encomenda");

      await fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams(formData)
      });

      alert("Encomenda registrada!");
      e.target.reset();
      carregarClientes();
      montarCalendario();
    });

    document.getElementById('form-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.append("tipo", "cliente");
      const nomeCliente = formData.get("nome");

      await fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams(formData)
      });

      alert("Cliente cadastrado!");
      e.target.reset();
      fecharModal();

      const dataList = document.getElementById("clientes");
      const option = document.createElement("option");
      option.value = nomeCliente;
      dataList.appendChild(option);
      document.getElementById("clienteSelect").value = nomeCliente;
    });

    async function carregarClientes() {
      const res = await fetch(scriptURL + '?tipo=listaClientes');
      const lista = await res.json();
      const dataList = document.getElementById('clientes');
      dataList.innerHTML = '';
      lista.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.nome;
        dataList.appendChild(option);
      });
    }

    async function montarCalendario() {
      const res = await fetch(scriptURL + '?tipo=listaEncomendas');
      const dados = await res.json();
      const eventos = dados.map((item, index) => ({
        title: `${item.cliente} - ${item.produto}`,
        start: item.dataEntrega,
        extendedProps: {
          index,
          cliente: item.cliente,
          valor: item.valor,
          status: item.status,
          adiantamento: item.adiantamento,
          valorFinal: item.valorFinal
        }
      }));

      const calendarEl = document.getElementById('calendario');
      calendarEl.innerHTML = '';
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listWeek'
        },
        events: eventos,
        eventClick: async function(info) {
          const props = info.event.extendedProps;
          const valorFinal = prompt(`Marcar como ENTREGUE para ${props.cliente}\nAdiantamento: R$ ${props.adiantamento}\nValor Estimado: R$ ${props.valor}\n\nInforme o valor final:`);

          if (valorFinal) {
            await fetch(scriptURL, {
              method: 'POST',
              body: new URLSearchParams({
                tipo: 'marcarEntregue',
                index: props.index,
                valorFinal
              })
            });
            alert("Status atualizado!");
            montarCalendario();
          }
        }
      });
      calendar.render();
    }

    carregarClientes();
    montarCalendario();
  </script>
</body>
</html>
